---
title: "Pokemon Type Effectiveness Analysis & Rating System"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: cosmo
    self_contained: true
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "reports"
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

## 1. Load Libraries and Data

```{r libraries}
library(tidyverse)
library(knitr)
library(glue)
library(here)  # For robust path handling

set.seed(123)
theme_set(theme_minimal(base_size = 12))
```

```{r load-data}
# Load type effectiveness data
type_df <- read_csv("data/def_type_df.csv")

# Load Pokemon data
pokemon_df <- read_csv("data/pokemon_data_final_evolutions_enriched.csv")

# Restore factor levels
pokemon_df$generation <- factor(pokemon_df$generation, levels = paste0("Gen ", 1:9))
pokemon_df$category <- factor(pokemon_df$category,
  levels = c("Regular", "Legendary", "Mythical", "Paradox", "Ultra Beast")
)

cat(glue("Type matchups: {nrow(type_df)} combinations\n"))
cat(glue("Pokemon dataset: {nrow(pokemon_df)} Pokemon\n"))
```

## 2. Type Effectiveness Analysis

### 2.1 Attack Type Analysis

Which attack types have the most super-effective matchups (x2 or x4 damage)?

```{r attack-effectiveness}
# Calculate attack effectiveness for single types only
single_types <- c("Normal", "Fire", "Water", "Electric", "Grass", "Ice",
                  "Fighting", "Poison", "Ground", "Flying", "Psychic", "Bug",
                  "Rock", "Ghost", "Dragon", "Dark", "Steel", "Fairy")

# Filter to single defense types only for base analysis
single_type_matchups <- type_df |>
  filter(def_type %in% single_types)

# Count super-effective (x2), not very effective (x0.5), and immune (x0) for each attack type
attack_stats <- single_type_matchups |>
  group_by(atk_type) |>
  summarise(
    super_effective = sum(multiplier == 2),
    not_effective = sum(multiplier == 0.5),
    immune = sum(multiplier == 0),
    neutral = sum(multiplier == 1),
    .groups = "drop"
  ) |>
  mutate(
    offensive_score = super_effective - not_effective - immune * 2,
    coverage_ratio = super_effective / 18
  ) |>
  arrange(desc(super_effective))

kable(attack_stats, caption = "Attack Type Effectiveness (vs Single Types)")
```

```{r attack-viz}
# Visualize attack effectiveness
attack_stats |>
  pivot_longer(cols = c(super_effective, not_effective, immune),
               names_to = "effectiveness", values_to = "count") |>
  mutate(effectiveness = factor(effectiveness,
    levels = c("super_effective", "neutral", "not_effective", "immune"))) |>
  ggplot(aes(x = reorder(atk_type, -count), y = count, fill = effectiveness)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("super_effective" = "#4CAF50",
                                "not_effective" = "#FF9800",
                                "immune" = "#F44336"),
                    labels = c("Super Effective (x2)", "Not Effective (x0.5)", "Immune (x0)")) +
  labs(
    title = "Attack Type Coverage",
    subtitle = "Number of types each attack type is super effective/not effective/immune against",
    x = "Attack Type", y = "Count", fill = "Effectiveness"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### 2.2 Best and Worst Attack Types

```{r best-attack}
# Best attack types (most super-effective)
best_attack <- attack_stats |>
  arrange(desc(super_effective)) |>
  head(5)

cat("=== TOP 5 ATTACK TYPES (Most Super-Effective Coverage) ===\n")
for (i in 1:nrow(best_attack)) {
  cat(glue("{i}. {best_attack$atk_type[i]}: {best_attack$super_effective[i]} types SE, {best_attack$not_effective[i]} types NVE, {best_attack$immune[i]} immunities\n\n"))
}

# Worst attack types (least super-effective + most resisted)
worst_attack <- attack_stats |>
  arrange(super_effective, desc(not_effective + immune)) |>
  head(5)

cat("\n=== BOTTOM 5 ATTACK TYPES (Least Effective Coverage) ===\n")
for (i in 1:nrow(worst_attack)) {
  cat(glue("{i}. {worst_attack$atk_type[i]}: {worst_attack$super_effective[i]} types SE, {worst_attack$not_effective[i]} types NVE, {worst_attack$immune[i]} immunities\n\n"))
}
```

### 2.3 Defense Type Analysis

Which defense types have the most resistances (x0.5, x0.25, x0) and fewest weaknesses (x2, x4)?

```{r defense-effectiveness}
# Calculate defense effectiveness for single types
defense_stats <- single_type_matchups |>
  group_by(def_type) |>
  summarise(
    weaknesses = sum(multiplier == 2),
    resistances = sum(multiplier == 0.5),
    immunities = sum(multiplier == 0),
    neutral = sum(multiplier == 1),
    .groups = "drop"
  ) |>
  mutate(
    defensive_score = resistances + immunities * 2 - weaknesses,
    resistance_ratio = (resistances + immunities) / 18
  ) |>
  arrange(desc(defensive_score))

kable(defense_stats, caption = "Defense Type Effectiveness (Single Types)")
```

```{r defense-viz}
# Visualize defense effectiveness
defense_stats |>
  pivot_longer(cols = c(weaknesses, resistances, immunities),
               names_to = "type", values_to = "count") |>
  mutate(type = factor(type, levels = c("resistances", "immunities", "weaknesses"))) |>
  ggplot(aes(x = reorder(def_type, -count), y = count, fill = type)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("resistances" = "#4CAF50",
                                "immunities" = "#2196F3",
                                "weaknesses" = "#F44336"),
                    labels = c("Resistances (x0.5)", "Immunities (x0)", "Weaknesses (x2)")) +
  labs(
    title = "Defense Type Resilience",
    subtitle = "Number of resistances, immunities, and weaknesses for each type",
    x = "Defense Type", y = "Count", fill = "Type"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### 2.4 Best and Worst Defense Types

```{r best-defense}
# Best defense types (most resistances + immunities, fewest weaknesses)
best_defense <- defense_stats |>
  arrange(desc(defensive_score)) |>
  head(5)

cat("=== TOP 5 DEFENSE TYPES (Best Defensive Profile) ===\n")
for (i in 1:nrow(best_defense)) {
  cat(glue("{i}. {best_defense$def_type[i]}: {best_defense$resistances[i]} resistances, {best_defense$immunities[i]} immunities, {best_defense$weaknesses[i]} weaknesses\n\n"))
}

# Worst defense types
worst_defense <- defense_stats |>
  arrange(defensive_score) |>
  head(5)

cat("\n=== BOTTOM 5 DEFENSE TYPES (Worst Defensive Profile) ===\n")
for (i in 1:nrow(worst_defense)) {
  cat(glue("{i}. {worst_defense$def_type[i]}: {worst_defense$resistances[i]} resistances, {worst_defense$immunities[i]} immunities, {worst_defense$weaknesses[i]} weaknesses\n\n"))
}
```

### 2.5 Dual Type Analysis

Analyze the best and worst dual-type combinations.

```{r dual-type-analysis}
# Get dual type combinations
dual_type_matchups <- type_df |>
  filter(str_detect(def_type, "/"))

# Calculate defense stats for dual types
dual_defense_stats <- dual_type_matchups |>
  group_by(def_type) |>
  summarise(
    weaknesses_4x = sum(multiplier == 4),
    weaknesses_2x = sum(multiplier == 2),
    resistances_half = sum(multiplier == 0.5),
    resistances_quarter = sum(multiplier == 0.25),
    immunities = sum(multiplier == 0),
    .groups = "drop"
  ) |>
  mutate(
    total_weaknesses = weaknesses_4x + weaknesses_2x,
    total_resistances = resistances_half + resistances_quarter + immunities,
    defensive_score = total_resistances - total_weaknesses - weaknesses_4x
  )

# Best dual types
best_dual <- dual_defense_stats |>
  arrange(desc(defensive_score)) |>
  head(10)

cat("=== TOP 10 DUAL TYPE COMBINATIONS (Defensive) ===\n")
kable(best_dual |> select(def_type, total_weaknesses, weaknesses_4x, total_resistances, immunities, defensive_score),
      caption = "Best Dual Type Combinations")

# Worst dual types
worst_dual <- dual_defense_stats |>
  arrange(defensive_score) |>
  head(10)

cat("\n=== BOTTOM 10 DUAL TYPE COMBINATIONS (Defensive) ===\n")
kable(worst_dual |> select(def_type, total_weaknesses, weaknesses_4x, total_resistances, immunities, defensive_score),
      caption = "Worst Dual Type Combinations")
```

## 3. Type Effectiveness Summary

```{r type-summary}
# Create comprehensive type score combining offense and defense
type_overall <- attack_stats |>
  select(type = atk_type, offensive_score) |>
  left_join(
    defense_stats |> select(type = def_type, defensive_score),
    by = "type"
  ) |>
  mutate(
    overall_score = offensive_score + defensive_score
  ) |>
  arrange(desc(overall_score))

kable(type_overall, caption = "Overall Type Rankings (Offense + Defense Combined)")

# Visualize overall type rankings
type_overall |>
  pivot_longer(cols = c(offensive_score, defensive_score),
               names_to = "score_type", values_to = "score") |>
  ggplot(aes(x = reorder(type, overall_score), y = score, fill = score_type)) +
  geom_col(position = "stack") +
  coord_flip() +
  scale_fill_manual(values = c("offensive_score" = "#E91E63", "defensive_score" = "#3F51B5"),
                    labels = c("Offensive", "Defensive")) +
  labs(
    title = "Overall Type Rankings",
    subtitle = "Combined offensive and defensive effectiveness scores",
    x = "Type", y = "Score", fill = "Score Type"
  )
```

## 4. Pokemon Rating System

### 4.1 Rating Components

We develop a **dual-rating system** (100-point scale each) for competitive battling:

**Offensive Rating (100 points):**
1. **Efficient Stat Total (40 points)**: S-curve BST mapping with effective attack calculation
2. **Stat Distribution - Offensive (60 points)**:
   - Effective Attack Power (50%): Mixed offense recognition
   - Effective Speed Score (40%): Dual tactical value (fast/slow strategies)
   - Durability Buffer (10%): Minimum survivability

**Defensive Rating (100 points):**
1. **Efficient Stat Total (40 points)**: Same S-curve BST mapping
2. **Stat Distribution - Defensive (30 points)**:
   - Durability Expectation (80%): HP × √(Def × SpDef)
   - Counter-Attack Ability (20%): Minimum offensive threat
3. **Type Advantages (30 points)**: Defensive type matchup score

```{r rating-components}
# Smooth BST Score Calculator (40 points max)
# Uses logistic function (S-curve) for smooth transition
calc_bst_score <- function(total, atk, spatk, eff_atk) {
  # Parameters for S-curve - adjusted for higher scores
  # Midpoint at BST=450 (shifted left to give higher scores overall)
  # Steepness: gradual transition from 250-700
  L <- 40      # Maximum score
  k <- 0.015   # Steepness (increased for faster growth)
  x0 <- 450    # Inflection point (lowered to boost scores)
  bst = total - atk - spatk + eff_atk  # Use effective attack to avoid double counting

  # Logistic function: L / (1 + exp(-k * (x - x0)))
  score <- L / (1 + exp(-k * (bst - x0)))

  # Ensure minimum of 5 points for very weak Pokemon
  return(score)
}

# Efficient Attack Power Calculator
# Recognizes mixed offense vs specialized attackers
calc_eff_atk <- function(atk, spatk){
  ratio <- pmin(atk, spatk) / pmax(atk, spatk)
  # If ratio >= 0.9, it's a mixed attacker: use weighted sum
  # Otherwise, it's specialized: use the higher value
  ifelse(ratio < 0.9, pmax(atk, spatk), 0.6*(atk + spatk))
}

# Durability Expectations Calculator
# Uses geometric mean to penalize unbalanced defenses
calc_eff_def <- function(hp, def, spdef){
  hp * sqrt(def * spdef)
}

# Effective Speed Score Calculator
# Dual evaluation: base speed + tactical value
calc_eff_spd <- function(spd, vmin, vmax, v0 = 80){
  # B: "Faster is better" - linear normalization
  B <- (spd - vmin) / (vmax - vmin)
  # D: "Tactical value" - distance from baseline speed
  # Both very fast and very slow have tactical value
  D <- (abs(spd - v0)) / max(v0 - vmin, vmax - v0)
  # Combined: base speed (67%) + tactical value (33%)
  B + 0.5 * D
}

# Offensive Stat Distribution Score (60 points)
calc_atk_score <- function(eff_atk_s, eff_def_s, eff_spd_s){
  # Attack-oriented: prioritize offense (50%) and speed (40%)
  # Minimal durability requirement (10%)
  (0.5*eff_atk_s + 0.1*eff_def_s + 0.4*eff_spd_s) * 60
}

# Defensive Stat Distribution Score (30 points from stats + 30 points from type)
calc_def_score <- function(eff_atk_s, eff_def_s, defense_score){
  # Defense-oriented: prioritize durability (80% of 30pts)
  # Keep some offensive threat (20% of 30pts)
  # Plus type advantage score (30pts from defensive matchups)
  (0.8*eff_def_s + 0.2*eff_atk_s) * 30 + 30 * defense_score/100
}
```

### 4.2 Prepare Defense Type Scores

```{r prepare-defense-scores}
# Load or calculate defense type scores from dual-type analysis
# Create type combination string in canonical order
TYPE_ORDER <- c(
  "Normal","Fire","Water","Electric","Grass","Ice",
  "Fighting","Poison","Ground","Flying","Psychic",
  "Bug","Rock","Ghost","Dragon","Dark","Steel","Fairy"
)

# Calculate defense scores for all type combinations
def_type_scores <- dual_defense_stats |>
  select(def_type, defensive_score) |>
  mutate(
    # Normalize to 0-100 scale
    defense_score = scales::rescale(defensive_score, to = c(0, 100))
  )

# Add single type defense scores
single_def_scores <- defense_stats |>
  select(def_type, defensive_score) |>
  mutate(
    defense_score = scales::rescale(defensive_score, to = c(0, 100))
  )

# Combine both
all_def_scores <- bind_rows(def_type_scores, single_def_scores)
```

### 4.3 Calculate Dual Ratings

```{r calculate-ratings}
# Add defense type column to Pokemon data
pokemon_df_typed <- pokemon_df |>
  mutate(
    idx1 = match(type_1, TYPE_ORDER),
    idx2 = match(type_2, TYPE_ORDER),
    def_type = case_when(
      is.na(type_2) ~ type_1,
      TRUE ~ paste(
        TYPE_ORDER[pmin(idx1, idx2)],
        TYPE_ORDER[pmax(idx1, idx2)],
        sep = "/"
      )
    )
  ) |>
  left_join(
    all_def_scores |> select(def_type, defense_score),
    by = "def_type"
  ) |>
  # Fill missing defense scores with median
  mutate(defense_score = ifelse(is.na(defense_score), 50, defense_score))

# Calculate rating for each Pokemon
pokemon_rated <- pokemon_df_typed |>
  mutate(
    # Step 1: Calculate raw effective values
    eff_atk = calc_eff_atk(attack, sp_atk),
    eff_def = calc_eff_def(hp, defense, sp_def),
    eff_spd = calc_eff_spd(speed, min(speed), max(speed)),

    # Step 2: Normalize to [0,1] scale
    eff_atk_s = eff_atk / max(eff_atk),
    eff_def_s = eff_def / max(eff_def),
    eff_spd_s = eff_spd / max(eff_spd),

    # Step 3: Calculate BST score (shared by both ratings)
    bst_score = calc_bst_score(total, attack, sp_atk, eff_atk),

    # Step 4: Calculate final ratings
    offensive_rating = bst_score + calc_atk_score(eff_atk_s, eff_def_s, eff_spd_s),
    defensive_rating = bst_score + calc_def_score(eff_atk_s, eff_def_s, defense_score),

    # Step 5: Create composite score (average of both)
    total_rating = (offensive_rating + defensive_rating) / 2,

    # Tier Assignment based on composite score
    tier = case_when(
      total_rating >= 75 ~ "S",  # Elite Pokemon
      total_rating >= 65 ~ "A",  # Strong Pokemon
      total_rating >= 55 ~ "B",  # Above average
      total_rating >= 45 ~ "C",  # Average
      total_rating >= 35 ~ "D",  # Below average
      TRUE ~ "F"                 # Weak Pokemon
    ),

    # Role classification based on rating difference
    role = case_when(
      offensive_rating - defensive_rating > 10 ~ "Offensive",
      defensive_rating - offensive_rating > 10 ~ "Defensive",
      TRUE ~ "Balanced"
    )
  )

# Set tier as factor
pokemon_rated$tier <- factor(pokemon_rated$tier, levels = c("S", "A", "B", "C", "D", "F"))
pokemon_rated$role <- factor(pokemon_rated$role, levels = c("Offensive", "Balanced", "Defensive"))
```

### 4.4 Visualize Scoring Functions

```{r visualize-scoring-functions}
# Create data for visualization
bst_range <- seq(200, 800, by = 5)
atk_pairs <- expand.grid(atk = seq(50, 200, 10), spatk = seq(50, 200, 10))
spd_range <- seq(5, 200, by = 5)

# BST Score visualization
bst_viz <- tibble(
  BST = bst_range,
  # Use dummy values for attack stats
  Score = sapply(bst_range, function(x) calc_bst_score(x, 100, 100, 100))
)

p1 <- ggplot(bst_viz, aes(x = BST, y = Score)) +
  geom_line(color = "#2196F3", size = 1.5) +
  geom_hline(yintercept = c(10, 20, 30, 40), linetype = "dashed", alpha = 0.3) +
  geom_vline(xintercept = 450, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 450, y = 35, label = "Inflection Point\n(BST=450)",
           color = "red", size = 3) +
  labs(
    title = "BST Score: Smooth S-Curve Mapping",
    subtitle = "Logistic function for gradual strength scaling",
    x = "Base Stat Total (BST)", y = "BST Score (max 40)"
  ) +
  theme_minimal()

# Effective Attack visualization
eff_atk_viz <- atk_pairs |>
  mutate(
    eff_atk = calc_eff_atk(atk, spatk),
    ratio = pmin(atk, spatk) / pmax(atk, spatk),
    type = ifelse(ratio >= 0.9, "Mixed", "Specialized")
  )

p2 <- ggplot(eff_atk_viz, aes(x = atk, y = spatk, fill = eff_atk)) +
  geom_tile() +
  geom_contour(aes(z = eff_atk), color = "white", alpha = 0.3) +
  scale_fill_viridis_c(option = "plasma") +
  geom_abline(slope = 1, linetype = "dashed", color = "white") +
  annotate("text", x = 180, y = 180, label = "Mixed\nOffense",
           color = "white", size = 4, fontface = "bold") +
  annotate("text", x = 180, y = 80, label = "Specialized",
           color = "white", size = 4, fontface = "bold") +
  labs(
    title = "Effective Attack Power",
    subtitle = "Recognizes mixed offense (ratio ≥ 0.9) vs specialization",
    x = "Attack", y = "Special Attack", fill = "Eff. Attack"
  ) +
  theme_minimal()

# Effective Speed visualization
spd_viz <- tibble(
  Speed = spd_range,
  Score = calc_eff_spd(spd_range, min(spd_range), max(spd_range)),
  # Decompose into components
  B = (spd_range - min(spd_range)) / (max(spd_range) - min(spd_range)),
  D = abs(spd_range - 80) / max(80 - min(spd_range), max(spd_range) - 80) * 0.5
)

p3 <- ggplot(spd_viz, aes(x = Speed)) +
  geom_line(aes(y = Score, color = "Total Score"), size = 1.5) +
  geom_line(aes(y = B, color = "Base Speed (B)"), linetype = "dashed") +
  geom_line(aes(y = D, color = "Tactical Value (D)"), linetype = "dotted") +
  geom_vline(xintercept = 80, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 80, y = 1.3, label = "Baseline\nSpeed=80",
           color = "red", size = 3) +
  scale_color_manual(values = c("Total Score" = "#4CAF50",
                                 "Base Speed (B)" = "#2196F3",
                                 "Tactical Value (D)" = "#FF9800")) +
  labs(
    title = "Effective Speed Score: Dual Tactical Value",
    subtitle = "Both very fast and very slow have strategic importance",
    x = "Speed Stat", y = "Normalized Score", color = "Component"
  ) +
  theme_minimal()

# Display all plots
if (requireNamespace("patchwork", quietly = TRUE)) {
  library(patchwork)
  (p1 | p2) / p3
} else {
  print(p1)
  print(p2)
  print(p3)
}
```

### 4.5 Rating Distribution Analysis

```{r rating-distribution}
# Summary by tier
tier_summary <- pokemon_rated |>
  count(tier) |>
  mutate(percentage = round(100 * n / sum(n), 1))

kable(tier_summary, caption = "Pokemon Distribution by Tier")

# Summary by role
role_summary <- pokemon_rated |>
  count(role) |>
  mutate(percentage = round(100 * n / sum(n), 1))

kable(role_summary, caption = "Pokemon Distribution by Battle Role")

# Visualize dual rating distribution
ggplot(pokemon_rated, aes(x = offensive_rating, y = defensive_rating)) +
  geom_point(aes(color = tier, shape = role), alpha = 0.6, size = 3) +
  geom_abline(slope = 1, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("S" = "#FFD700", "A" = "#C0C0C0", "B" = "#CD7F32",
                                 "C" = "#4CAF50", "D" = "#2196F3", "F" = "#9E9E9E")) +
  labs(
    title = "Offensive vs Defensive Rating Distribution",
    subtitle = "Points above diagonal = defense-oriented, below = offense-oriented",
    x = "Offensive Rating", y = "Defensive Rating",
    color = "Tier", shape = "Role"
  ) +
  theme_minimal()

# Rating distribution histogram
ggplot(pokemon_rated, aes(x = total_rating, fill = tier)) +
  geom_histogram(bins = 30, alpha = 0.8) +
  scale_fill_manual(values = c("S" = "#FFD700", "A" = "#C0C0C0", "B" = "#CD7F32",
                                "C" = "#4CAF50", "D" = "#2196F3", "F" = "#9E9E9E")) +
  labs(
    title = "Composite Rating Distribution",
    subtitle = "Average of offensive and defensive ratings",
    x = "Total Rating (100-point scale)", y = "Count", fill = "Tier"
  ) +
  theme_minimal()

# Rating by role
ggplot(pokemon_rated, aes(x = role, y = total_rating, fill = role)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = c("Offensive" = "#E91E63",
                                "Balanced" = "#9C27B0",
                                "Defensive" = "#3F51B5")) +
  labs(
    title = "Rating Distribution by Battle Role",
    x = "Battle Role", y = "Composite Rating"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

### 4.6 Top Rated Pokemon

```{r top-rated}
# Top 20 offensive Pokemon
top_offensive <- pokemon_rated |>
  arrange(desc(offensive_rating)) |>
  head(20) |>
  select(name, type_1, type_2, role, offensive_rating, defensive_rating, tier, eff_atk)

cat("=== TOP 20 OFFENSIVE POKEMON ===\n")
kable(top_offensive, caption = "Top 20 Offensive Pokemon", digits = 1)

# Top 20 defensive Pokemon
top_defensive <- pokemon_rated |>
  arrange(desc(defensive_rating)) |>
  head(20) |>
  select(name, type_1, type_2, def_type, role, defensive_rating, offensive_rating, tier, defense_score)

cat("\n=== TOP 20 DEFENSIVE POKEMON ===\n")
kable(top_defensive, caption = "Top 20 Defensive Pokemon", digits = 1)

# Top 20 balanced Pokemon (high composite score)
top_balanced <- pokemon_rated |>
  filter(role == "Balanced") |>
  arrange(desc(total_rating)) |>
  head(20) |>
  select(name, type_1, type_2, total_rating, offensive_rating, defensive_rating, tier)

cat("\n=== TOP 20 BALANCED POKEMON ===\n")
kable(top_balanced, caption = "Top 20 Balanced Pokemon", digits = 1)

# Top regular Pokemon (for beginners)
top_regular <- pokemon_rated |>
  filter(category == "Regular") |>
  arrange(desc(total_rating)) |>
  head(20) |>
  select(name, type_1, type_2, role, total_rating, offensive_rating, defensive_rating, tier)

cat("\n=== TOP 20 REGULAR POKEMON (For Beginners) ===\n")
kable(top_regular, caption = "Top 20 Regular Pokemon", digits = 1)
```

### 4.7 Best Pokemon by Type

```{r best-by-type}
# Best offensive Pokemon for each primary type
best_offensive_by_type <- pokemon_rated |>
  filter(category == "Regular") |>
  group_by(type_1) |>
  slice_max(offensive_rating, n = 1) |>
  ungroup() |>
  arrange(desc(offensive_rating)) |>
  select(type_1, name, offensive_rating, role, tier)

cat("=== BEST OFFENSIVE POKEMON BY TYPE (Regular Only) ===\n")
kable(best_offensive_by_type, caption = "Best Offensive Pokemon by Type", digits = 1)

# Best defensive Pokemon for each primary type
best_defensive_by_type <- pokemon_rated |>
  filter(category == "Regular") |>
  group_by(type_1) |>
  slice_max(defensive_rating, n = 1) |>
  ungroup() |>
  arrange(desc(defensive_rating)) |>
  select(type_1, name, defensive_rating, role, tier)

cat("\n=== BEST DEFENSIVE POKEMON BY TYPE (Regular Only) ===\n")
kable(best_defensive_by_type, caption = "Best Defensive Pokemon by Type", digits = 1)
```

### 4.8 Export Results

```{r export-results}
# Create output directory
dir.create(here("data", "analysis", "rating"), recursive = TRUE, showWarnings = FALSE)

# Save rated Pokemon data to CSV
write_csv(pokemon_rated, here("data", "analysis", "rating", "pokemon_rated_dual.csv"))

# Create summary statistics
rating_summary <- pokemon_rated |>
  summarise(
    total_pokemon = n(),
    avg_total_rating = mean(total_rating),
    avg_offensive_rating = mean(offensive_rating),
    avg_defensive_rating = mean(defensive_rating),
    median_total_rating = median(total_rating),
    min_total_rating = min(total_rating),
    max_total_rating = max(total_rating),
    s_tier_count = sum(tier == "S"),
    a_tier_count = sum(tier == "A"),
    b_tier_count = sum(tier == "B"),
    c_tier_count = sum(tier == "C"),
    d_tier_count = sum(tier == "D"),
    f_tier_count = sum(tier == "F"),
    offensive_count = sum(role == "Offensive"),
    balanced_count = sum(role == "Balanced"),
    defensive_count = sum(role == "Defensive"),
    avg_bst_score = mean(bst_score),
    avg_eff_atk = mean(eff_atk),
    avg_eff_def = mean(eff_def),
    avg_eff_spd = mean(eff_spd)
  )

write_csv(rating_summary, here("data", "analysis", "rating", "rating_summary_dual.csv"))

# Export top Pokemon lists for reference
write_csv(top_offensive, here("data", "analysis", "rating", "top_offensive_pokemon.csv"))
write_csv(top_defensive, here("data", "analysis", "rating", "top_defensive_pokemon.csv"))
write_csv(top_balanced, here("data", "analysis", "rating", "top_balanced_pokemon.csv"))
write_csv(top_regular, here("data", "analysis", "rating", "top_regular_pokemon.csv"))

cat("\n=== DUAL RATING SYSTEM SUMMARY ===\n")
cat(sprintf("Total Pokemon: %d\n", rating_summary$total_pokemon))
cat(sprintf("\nAverage Ratings:\n"))
cat(sprintf("  Composite Rating: %.1f / 100\n", rating_summary$avg_total_rating))
cat(sprintf("  Offensive Rating: %.1f / 100\n", rating_summary$avg_offensive_rating))
cat(sprintf("  Defensive Rating: %.1f / 100\n", rating_summary$avg_defensive_rating))
cat(sprintf("\nRating Range: %.1f - %.1f\n", rating_summary$min_total_rating, rating_summary$max_total_rating))
cat(sprintf("\nTier Distribution:\n"))
cat(sprintf("  S Tier: %d (%.1f%%)\n", rating_summary$s_tier_count, 100*rating_summary$s_tier_count/rating_summary$total_pokemon))
cat(sprintf("  A Tier: %d (%.1f%%)\n", rating_summary$a_tier_count, 100*rating_summary$a_tier_count/rating_summary$total_pokemon))
cat(sprintf("  B Tier: %d (%.1f%%)\n", rating_summary$b_tier_count, 100*rating_summary$b_tier_count/rating_summary$total_pokemon))
cat(sprintf("  C Tier: %d (%.1f%%)\n", rating_summary$c_tier_count, 100*rating_summary$c_tier_count/rating_summary$total_pokemon))
cat(sprintf("  D Tier: %d (%.1f%%)\n", rating_summary$d_tier_count, 100*rating_summary$d_tier_count/rating_summary$total_pokemon))
cat(sprintf("  F Tier: %d (%.1f%%)\n", rating_summary$f_tier_count, 100*rating_summary$f_tier_count/rating_summary$total_pokemon))
cat(sprintf("\nRole Distribution:\n"))
cat(sprintf("  Offensive: %d (%.1f%%)\n", rating_summary$offensive_count, 100*rating_summary$offensive_count/rating_summary$total_pokemon))
cat(sprintf("  Balanced: %d (%.1f%%)\n", rating_summary$balanced_count, 100*rating_summary$balanced_count/rating_summary$total_pokemon))
cat(sprintf("  Defensive: %d (%.1f%%)\n", rating_summary$defensive_count, 100*rating_summary$defensive_count/rating_summary$total_pokemon))
cat(sprintf("\nComponent Score Averages:\n"))
cat(sprintf("  BST Score: %.1f / 40\n", rating_summary$avg_bst_score))
cat(sprintf("  Effective Attack: %.1f\n", rating_summary$avg_eff_atk))
cat(sprintf("  Effective Defense: %.1f\n", rating_summary$avg_eff_def))
cat(sprintf("  Effective Speed: %.1f\n", rating_summary$avg_eff_spd))

cat("\n✓ Results exported to data/analysis/rating/:\n")
cat("  - pokemon_rated_dual.csv (Complete ratings)\n")
cat("  - rating_summary_dual.csv (Summary statistics)\n")
cat("  - top_offensive_pokemon.csv (Top 20 offensive)\n")
cat("  - top_defensive_pokemon.csv (Top 20 defensive)\n")
cat("  - top_balanced_pokemon.csv (Top 20 balanced)\n")
cat("  - top_regular_pokemon.csv (Top 20 for beginners)\n")
```
