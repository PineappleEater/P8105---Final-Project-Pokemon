---
title: "Pokemon Type Effectiveness Analysis & Rating System"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: cosmo
    self_contained: true
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "reports"
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

## 1. Load Libraries and Data

```{r libraries}
library(tidyverse)
library(knitr)
library(glue)
library(here)  # For robust path handling

set.seed(123)
theme_set(theme_minimal(base_size = 12))
```

```{r load-data}
# Load type effectiveness data
type_df <- read_csv("data/def_type_df.csv")

# Load Pokemon data
pokemon_df <- read_csv("data/pokemon_data_final_evolutions_enriched.csv")

# Restore factor levels
pokemon_df$generation <- factor(pokemon_df$generation, levels = paste0("Gen ", 1:9))
pokemon_df$category <- factor(pokemon_df$category,
  levels = c("Regular", "Legendary", "Mythical", "Paradox", "Ultra Beast")
)

cat(glue("Type matchups: {nrow(type_df)} combinations\n"))
cat(glue("Pokemon dataset: {nrow(pokemon_df)} Pokemon\n"))
```

## 2. Type Effectiveness Analysis

### 2.1 Attack Type Analysis

Which attack types have the most super-effective matchups (x2 or x4 damage)?

```{r attack-effectiveness}
# Calculate attack effectiveness for single types only
single_types <- c("Normal", "Fire", "Water", "Electric", "Grass", "Ice",
                  "Fighting", "Poison", "Ground", "Flying", "Psychic", "Bug",
                  "Rock", "Ghost", "Dragon", "Dark", "Steel", "Fairy")

# Filter to single defense types only for base analysis
single_type_matchups <- type_df |>
  filter(def_type %in% single_types)

# Count super-effective (x2), not very effective (x0.5), and immune (x0) for each attack type
attack_stats <- single_type_matchups |>
  group_by(atk_type) |>
  summarise(
    super_effective = sum(multiplier == 2),
    not_effective = sum(multiplier == 0.5),
    immune = sum(multiplier == 0),
    neutral = sum(multiplier == 1),
    .groups = "drop"
  ) |>
  mutate(
    offensive_score = super_effective - not_effective - immune * 2,
    coverage_ratio = super_effective / 18
  ) |>
  arrange(desc(super_effective))

kable(attack_stats, caption = "Attack Type Effectiveness (vs Single Types)")
```

```{r attack-viz}
# Visualize attack effectiveness
attack_stats |>
  pivot_longer(cols = c(super_effective, not_effective, immune),
               names_to = "effectiveness", values_to = "count") |>
  mutate(effectiveness = factor(effectiveness,
    levels = c("super_effective", "neutral", "not_effective", "immune"))) |>
  ggplot(aes(x = reorder(atk_type, -count), y = count, fill = effectiveness)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("super_effective" = "#4CAF50",
                                "not_effective" = "#FF9800",
                                "immune" = "#F44336"),
                    labels = c("Super Effective (x2)", "Not Effective (x0.5)", "Immune (x0)")) +
  labs(
    title = "Attack Type Coverage",
    subtitle = "Number of types each attack type is super effective/not effective/immune against",
    x = "Attack Type", y = "Count", fill = "Effectiveness"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### 2.2 Best and Worst Attack Types

```{r best-attack}
# Best attack types (most super-effective)
best_attack <- attack_stats |>
  arrange(desc(super_effective)) |>
  head(5)

cat("=== TOP 5 ATTACK TYPES (Most Super-Effective Coverage) ===\n")
for (i in 1:nrow(best_attack)) {
  cat(glue("{i}. {best_attack$atk_type[i]}: {best_attack$super_effective[i]} types SE, {best_attack$not_effective[i]} types NVE, {best_attack$immune[i]} immunities\n\n"))
}

# Worst attack types (least super-effective + most resisted)
worst_attack <- attack_stats |>
  arrange(super_effective, desc(not_effective + immune)) |>
  head(5)

cat("\n=== BOTTOM 5 ATTACK TYPES (Least Effective Coverage) ===\n")
for (i in 1:nrow(worst_attack)) {
  cat(glue("{i}. {worst_attack$atk_type[i]}: {worst_attack$super_effective[i]} types SE, {worst_attack$not_effective[i]} types NVE, {worst_attack$immune[i]} immunities\n\n"))
}
```

### 2.3 Defense Type Analysis

Which defense types have the most resistances (x0.5, x0.25, x0) and fewest weaknesses (x2, x4)?

```{r defense-effectiveness}
# Calculate defense effectiveness for single types
defense_stats <- single_type_matchups |>
  group_by(def_type) |>
  summarise(
    weaknesses = sum(multiplier == 2),
    resistances = sum(multiplier == 0.5),
    immunities = sum(multiplier == 0),
    neutral = sum(multiplier == 1),
    .groups = "drop"
  ) |>
  mutate(
    defensive_score = resistances + immunities * 2 - weaknesses,
    resistance_ratio = (resistances + immunities) / 18
  ) |>
  arrange(desc(defensive_score))

kable(defense_stats, caption = "Defense Type Effectiveness (Single Types)")
```

```{r defense-viz}
# Visualize defense effectiveness
defense_stats |>
  pivot_longer(cols = c(weaknesses, resistances, immunities),
               names_to = "type", values_to = "count") |>
  mutate(type = factor(type, levels = c("resistances", "immunities", "weaknesses"))) |>
  ggplot(aes(x = reorder(def_type, -count), y = count, fill = type)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("resistances" = "#4CAF50",
                                "immunities" = "#2196F3",
                                "weaknesses" = "#F44336"),
                    labels = c("Resistances (x0.5)", "Immunities (x0)", "Weaknesses (x2)")) +
  labs(
    title = "Defense Type Resilience",
    subtitle = "Number of resistances, immunities, and weaknesses for each type",
    x = "Defense Type", y = "Count", fill = "Type"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### 2.4 Best and Worst Defense Types

```{r best-defense}
# Best defense types (most resistances + immunities, fewest weaknesses)
best_defense <- defense_stats |>
  arrange(desc(defensive_score)) |>
  head(5)

cat("=== TOP 5 DEFENSE TYPES (Best Defensive Profile) ===\n")
for (i in 1:nrow(best_defense)) {
  cat(glue("{i}. {best_defense$def_type[i]}: {best_defense$resistances[i]} resistances, {best_defense$immunities[i]} immunities, {best_defense$weaknesses[i]} weaknesses\n\n"))
}

# Worst defense types
worst_defense <- defense_stats |>
  arrange(defensive_score) |>
  head(5)

cat("\n=== BOTTOM 5 DEFENSE TYPES (Worst Defensive Profile) ===\n")
for (i in 1:nrow(worst_defense)) {
  cat(glue("{i}. {worst_defense$def_type[i]}: {worst_defense$resistances[i]} resistances, {worst_defense$immunities[i]} immunities, {worst_defense$weaknesses[i]} weaknesses\n\n"))
}
```

### 2.5 Dual Type Analysis

Analyze the best and worst dual-type combinations.

```{r dual-type-analysis}
# Get dual type combinations
dual_type_matchups <- type_df |>
  filter(str_detect(def_type, "/"))

# Calculate defense stats for dual types
dual_defense_stats <- dual_type_matchups |>
  group_by(def_type) |>
  summarise(
    weaknesses_4x = sum(multiplier == 4),
    weaknesses_2x = sum(multiplier == 2),
    resistances_half = sum(multiplier == 0.5),
    resistances_quarter = sum(multiplier == 0.25),
    immunities = sum(multiplier == 0),
    .groups = "drop"
  ) |>
  mutate(
    total_weaknesses = weaknesses_4x + weaknesses_2x,
    total_resistances = resistances_half + resistances_quarter + immunities,
    defensive_score = total_resistances - total_weaknesses - weaknesses_4x
  )

# Best dual types
best_dual <- dual_defense_stats |>
  arrange(desc(defensive_score)) |>
  head(10)

cat("=== TOP 10 DUAL TYPE COMBINATIONS (Defensive) ===\n")
kable(best_dual |> select(def_type, total_weaknesses, weaknesses_4x, total_resistances, immunities, defensive_score),
      caption = "Best Dual Type Combinations")

# Worst dual types
worst_dual <- dual_defense_stats |>
  arrange(defensive_score) |>
  head(10)

cat("\n=== BOTTOM 10 DUAL TYPE COMBINATIONS (Defensive) ===\n")
kable(worst_dual |> select(def_type, total_weaknesses, weaknesses_4x, total_resistances, immunities, defensive_score),
      caption = "Worst Dual Type Combinations")
```

## 3. Type Effectiveness Summary

```{r type-summary}
# Create comprehensive type score combining offense and defense
type_overall <- attack_stats |>
  select(type = atk_type, offensive_score) |>
  left_join(
    defense_stats |> select(type = def_type, defensive_score),
    by = "type"
  ) |>
  mutate(
    overall_score = offensive_score + defensive_score
  ) |>
  arrange(desc(overall_score))

kable(type_overall, caption = "Overall Type Rankings (Offense + Defense Combined)")

# Visualize overall type rankings
type_overall |>
  pivot_longer(cols = c(offensive_score, defensive_score),
               names_to = "score_type", values_to = "score") |>
  ggplot(aes(x = reorder(type, overall_score), y = score, fill = score_type)) +
  geom_col(position = "stack") +
  coord_flip() +
  scale_fill_manual(values = c("offensive_score" = "#E91E63", "defensive_score" = "#3F51B5"),
                    labels = c("Offensive", "Defensive")) +
  labs(
    title = "Overall Type Rankings",
    subtitle = "Combined offensive and defensive effectiveness scores",
    x = "Type", y = "Score", fill = "Score Type"
  )
```

## 4. Pokemon Rating System

### 4.1 Rating Components

We develop a 100-point rating system for beginners with the following components:

1. **Base Stat Total (40 points)**: Raw power indicator
2. **Type Score (30 points)**: Offensive + defensive type advantages
3. **Stat Distribution (20 points)**: Balance vs specialization
4. **Accessibility (10 points)**: Non-legendary bonus

```{r rating-components}
# Create type score lookup from our analysis
type_scores <- type_overall |>
  mutate(
    # Normalize to 0-15 scale for primary type
    type_score_normalized = scales::rescale(overall_score, to = c(0, 15))
  )

# Function to get type score
get_type_score <- function(type1, type2, type_scores_df) {
  score1 <- type_scores_df$type_score_normalized[type_scores_df$type == type1]
  score1 <- ifelse(length(score1) == 0, 7.5, score1)

  if (is.na(type2)) {
    return(score1 * 2)  # Single type gets full weight
  } else {
    score2 <- type_scores_df$type_score_normalized[type_scores_df$type == type2]
    score2 <- ifelse(length(score2) == 0, 7.5, score2)
    return(score1 + score2)
  }
}

# Calculate stat distribution score (penalize extreme variance)
calc_stat_balance <- function(hp, atk, def, spatk, spdef, spd) {
  stats <- c(hp, atk, def, spatk, spdef, spd)
  cv <- sd(stats) / mean(stats)  # Coefficient of variation

  # Lower CV = more balanced = higher score
  # Scale: CV of 0.1 = 20 points, CV of 0.8 = 5 points
  balance_score <- 20 - (cv - 0.1) * 21.43
  return(max(5, min(20, balance_score)))
}
```

### 4.2 Calculate Ratings

```{r calculate-ratings}
# Calculate rating for each Pokemon
pokemon_rated <- pokemon_df |>
  rowwise() |>
  mutate(
    # BST Score (40 points)
    bst_score = case_when(
      total >= 600 ~ 40,
      total >= 550 ~ 35,
      total >= 500 ~ 30,
      total >= 450 ~ 25,
      total >= 400 ~ 20,
      total >= 350 ~ 15,
      TRUE ~ 10
    ),

    # Type Score (30 points)
    type_score = get_type_score(type_1, type_2, type_scores),

    # Stat Balance Score (20 points)
    balance_score = calc_stat_balance(hp, attack, defense, sp_atk, sp_def, speed),

    # Accessibility Score (10 points) - non-legendary gets bonus
    access_score = case_when(
      category == "Regular" ~ 10,
      category == "Paradox" ~ 8,
      category == "Ultra Beast" ~ 5,
      category == "Mythical" ~ 3,
      category == "Legendary" ~ 0
    ),

    # Total Rating
    total_rating = bst_score + type_score + balance_score + access_score,

    # Tier Assignment
    tier = case_when(
      total_rating >= 85 ~ "S",
      total_rating >= 75 ~ "A",
      total_rating >= 65 ~ "B",
      total_rating >= 55 ~ "C",
      total_rating >= 45 ~ "D",
      TRUE ~ "F"
    )
  ) |>
  ungroup()

# Set tier as factor
pokemon_rated$tier <- factor(pokemon_rated$tier, levels = c("S", "A", "B", "C", "D", "F"))
```

### 4.3 Rating Distribution

```{r rating-distribution}
# Summary by tier
tier_summary <- pokemon_rated |>
  count(tier) |>
  mutate(percentage = round(100 * n / sum(n), 1))

kable(tier_summary, caption = "Pokemon Distribution by Tier")

# Visualize rating distribution
ggplot(pokemon_rated, aes(x = total_rating, fill = tier)) +
  geom_histogram(bins = 30, alpha = 0.8) +
  scale_fill_manual(values = c("S" = "#FFD700", "A" = "#C0C0C0", "B" = "#CD7F32",
                                "C" = "#4CAF50", "D" = "#2196F3", "F" = "#9E9E9E")) +
  labs(
    title = "Pokemon Rating Distribution",
    x = "Total Rating (100-point scale)", y = "Count", fill = "Tier"
  )

# Rating by category
ggplot(pokemon_rated, aes(x = category, y = total_rating, fill = category)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Rating Distribution by Pokemon Category",
    x = "Category", y = "Total Rating"
  ) +
  theme(legend.position = "none")
```

### 4.4 Top Rated Pokemon (For Beginners)

```{r top-rated}
# Top 20 highest rated Pokemon (excluding legendaries for beginner focus)
top_regular <- pokemon_rated |>
  filter(category == "Regular") |>
  arrange(desc(total_rating)) |>
  head(20) |>
  select(name, type_1, type_2, total, total_rating, tier, bst_score, type_score, balance_score)

cat("=== TOP 20 POKEMON FOR BEGINNERS (Regular Pokemon Only) ===\n")
kable(top_regular, caption = "Top 20 Rated Regular Pokemon", digits = 1)

# Top overall including all categories
top_all <- pokemon_rated |>
  arrange(desc(total_rating)) |>
  head(20) |>
  select(name, category, type_1, type_2, total, total_rating, tier)

cat("\n=== TOP 20 POKEMON OVERALL (All Categories) ===\n")
kable(top_all, caption = "Top 20 Rated Pokemon Overall", digits = 1)
```

### 4.5 Best Pokemon by Type

```{r best-by-type}
# Best rated Pokemon for each primary type
best_by_type <- pokemon_rated |>
  filter(category == "Regular") |>
  group_by(type_1) |>
  slice_max(total_rating, n = 1) |>
  ungroup() |>
  arrange(desc(total_rating)) |>
  select(type_1, name, total, total_rating, tier)

cat("=== BEST REGULAR POKEMON BY PRIMARY TYPE ===\n")
kable(best_by_type, caption = "Best Rated Regular Pokemon by Type", digits = 1)
```
