---
title: "Pokemon Type Effectiveness Analysis & Rating System"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: cosmo
    self_contained: true
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "reports"
    )
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)
```

## 1. Load Libraries and Data

```{r libraries}
library(tidyverse)
library(knitr)
library(glue)
library(here)  # For robust path handling

set.seed(123)
theme_set(theme_minimal(base_size = 12))
```

```{r load-data}
# Load type effectiveness data
type_df <- read_csv("data/def_type_df.csv")

# Load Pokemon data
pokemon_df <- read_csv("data/pokemon_data_final_evolutions_enriched.csv")

# Restore factor levels
pokemon_df$generation <- factor(pokemon_df$generation, levels = paste0("Gen ", 1:9))
pokemon_df$category <- factor(pokemon_df$category,
  levels = c("Regular", "Legendary", "Mythical", "Paradox", "Ultra Beast")
)

cat(glue("Type matchups: {nrow(type_df)} combinations\n"))
cat(glue("Pokemon dataset: {nrow(pokemon_df)} Pokemon\n"))
```

## 2. Type Effectiveness Analysis

### 2.1 Attack Type Analysis

Which attack types have the most super-effective matchups (x2 or x4 damage)?

```{r attack-effectiveness}
# Count super-effective (x2, x4), not very effective (x0.5, x0.25), and immune (x0) for each attack type
attack_stats <- type_df |>
  group_by(atk_type) |>
  summarise(
    super_effective_x4 = sum(multiplier == 4),
    super_effective = sum(multiplier == 2),
    not_effective = sum(multiplier %in% c(0.5, 0.25)),
    immune = sum(multiplier == 0),
    neutral = sum(multiplier == 1),
    .groups = "drop"
  )

cols_list_max <- c("super_effective_x4", "super_effective", "neutral")
cols_list_min <- c("not_effective")

atk_stats_scaled <- attack_stats |>
  mutate(
    round(across(
      all_of(cols_list_max),
      ~ .x / max(.x) 
    ),2),
    round(across(
      all_of(cols_list_min),
      ~ .x / max(.x) 
    ),2),
    immune = if_else(immune > 0, 1, 0),
    offensive_score = (
      super_effective_x4*0.2	+ super_effective*0.6 + neutral*0.2	- not_effective*0.15)*100 - immune*10,
    ) |> 
  select(atk_type, offensive_score) |> 
  left_join(attack_stats, by = "atk_type") |> 
  mutate(
    atk_type = reorder(atk_type, offensive_score)
  )

kable(atk_stats_scaled, caption = "Attack Type Effectiveness")
```

```{r attack-viz}
# Visualize attack effectiveness
atk_stats_scaled |>
  pivot_longer(
    cols = c(super_effective_x4, super_effective, neutral, not_effective, immune),
    names_to = "effectiveness",
    values_to = "count"
  ) |>
  mutate(
    effectiveness = factor(
      effectiveness,
      levels = c("super_effective_x4", "super_effective", "neutral", "not_effective", "immune")
    )
  ) |>
  ggplot(aes(x = reorder(atk_type, -count), y = count, fill = effectiveness)) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = c(
      "super_effective_x4" = "#FF6347",
      "super_effective"    = "#4CAF50",
      "neutral"            = "#9E9E9E",
      "not_effective"      = "#FF9800",
      "immune"             = "#D3D3D3"
    ),
    labels = c(
      "super_effective_x4" = "Super Effective (x4)",
      "super_effective"    = "Super Effective (x2)",
      "neutral"            = "Neutral (x1)",
      "not_effective"      = "Not Effective (x0.5 / 0.25)",
      "immune"             = "Immune (x0)"
    )
  ) +
  labs(
    title = "Attack Type Coverage(Worst to Best)",
    subtitle = "Count of defensive matchups for each attack type across five effectiveness levels",
    x = "Attack Type",
    y = "Count",
    fill = "Effectiveness"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


### 2.2 Defense Type Analysis

Which defense types have the most resistances (x0.5, x0.25, x0) and fewest weaknesses (x2, x4)?

```{r defense-effectiveness}
# Calculate defense effectiveness for single types
defense_stats <- type_df |>
  group_by(def_type) |>
  summarise(
    weaknesses = sum(multiplier == 2),
    weaknesses_x4 = sum(multiplier == 4),
    strong_resistances = sum(multiplier == 0.25),
    resistances = sum(multiplier == 0.5),
    immunities = sum(multiplier == 0),
    neutral = sum(multiplier == 1),
    .groups = "drop"
  ) 

cols_list_max <- c("strong_resistances", "resistances", "neutral")
cols_list_min <- c("weaknesses_x4", "weaknesses")

def_stats_scaled <- defense_stats |>
  mutate(
    across(
      all_of(cols_list_max),
      ~ round(.x / max(.x),2) 
    ),
    across(
      all_of(cols_list_min),
      ~ round(.x / max(.x),2) 
    ),
    defensive_score = (
      strong_resistances*0.2	+ resistances*0.45 + neutral*0.2	- weaknesses_x4*0.1 - weaknesses*0.05)*100 + immunities*5) |> 
  select(def_type, defensive_score) |> 
  left_join(defense_stats, by = "def_type") |> 
  arrange(desc(defensive_score))


kable(head(def_stats_scaled, 10), caption = "Defence Type Effectiveness(Top 10)")
```

#### 2.2.1 Best 15 Defense Type  

```{r defense-viz top 15}
# Visualize defense effectiveness
def_stats_scaled |>
  arrange(desc(defensive_score)) |>
  slice_head(n = 15) |>
  mutate(
    def_type = factor(def_type, levels = def_type)
  ) |> 
  pivot_longer(
    cols = c(
      weaknesses_x4,
      weaknesses,
      neutral,
      strong_resistances,
      resistances,
      immunities
    ),
    names_to = "effectiveness",
    values_to = "count"
  ) |>
  mutate(
    effectiveness = factor(
      effectiveness,
      levels = c(
        "weaknesses_x4",
        "weaknesses",
        "neutral",
        "strong_resistances",
        "resistances",
        "immunities"
      )
    )
  ) |>
  ggplot(aes(x = def_type, y = count, fill = effectiveness)) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = c(
      "weaknesses_x4"      = "#B71C1C",
      "weaknesses"         = "#F44336",
      "neutral"            = "#9E9E9E",
      "strong_resistances" = "#2E7D32",
      "resistances"        = "#4CAF50",
      "immunities"         = "#2196F3"
    ),
    labels = c(
      "weaknesses_x4"      = "4x Weaknesses (x4)",
      "weaknesses"         = "Weaknesses (x2)",
      "neutral"            = "Neutral (x1)",
      "strong_resistances" = "Strong Resistances (x0.25)",
      "resistances"        = "Resistances (x0.5)",
      "immunities"         = "Immunities (x0)"
    )
  ) +
  labs(
    title    = "Defense Type Effectiveness Profile(Top 15 best, left is better)",
    subtitle = "Counts of weaknesses, resistances, and immunities for each defensive typing",
    x = "Defense Type",
    y = "Count",
    fill = "Effectiveness"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

#### 2.2.2 Worst 15 Defense Type  

```{r defense-viz bottom 15}
# Visualize defense effectiveness
def_stats_scaled |>
  arrange(defensive_score) |>
  slice_head(n = 15) |>
  mutate(
    def_type = factor(def_type, levels = def_type)
  ) |> 
  pivot_longer(
    cols = c(
      weaknesses_x4,
      weaknesses,
      neutral,
      strong_resistances,
      resistances,
      immunities
    ),
    names_to = "effectiveness",
    values_to = "count"
  ) |>
  mutate(
    effectiveness = factor(
      effectiveness,
      levels = c(
        "weaknesses_x4",
        "weaknesses",
        "neutral",
        "strong_resistances",
        "resistances",
        "immunities"
      )
    )
  ) |>
  ggplot(aes(x = def_type, y = count, fill = effectiveness)) +
  geom_col(position = "dodge") +
  scale_fill_manual(
    values = c(
      "weaknesses_x4"      = "#B71C1C",
      "weaknesses"         = "#F44336",
      "neutral"            = "#9E9E9E",
      "strong_resistances" = "#2E7D32",
      "resistances"        = "#4CAF50",
      "immunities"         = "#2196F3"
    ),
    labels = c(
      "weaknesses_x4"      = "4x Weaknesses (x4)",
      "weaknesses"         = "Weaknesses (x2)",
      "neutral"            = "Neutral (x1)",
      "strong_resistances" = "Strong Resistances (x0.25)",
      "resistances"        = "Resistances (x0.5)",
      "immunities"         = "Immunities (x0)"
    )
  ) +
  labs(
    title    = "Defense Type Effectiveness Profile(Top 15 worst, left is worser)",
    subtitle = "Counts of weaknesses, resistances, and immunities for each defensive typing",
    x = "Defense Type",
    y = "Count",
    fill = "Effectiveness"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

## 3. Type Effectiveness Summary

```{r type-summary}
# Create comprehensive type score combining offense and defense
type_overall <- atk_stats_scaled |>
  select(type = atk_type, offensive_score) |>
  left_join(
    def_stats_scaled |> select(type = def_type, defensive_score),
    by = "type"
  ) |>
  mutate(
    overall_score = offensive_score + defensive_score
  ) |>
  arrange(desc(overall_score))

kable(type_overall, caption = "Overall Type Rankings (Offense + Defense Combined)")

# Visualize overall type rankings
type_overall |>
  pivot_longer(cols = c(offensive_score, defensive_score),
               names_to = "score_type", values_to = "score") |>
  ggplot(aes(x = reorder(type, overall_score), y = score, fill = score_type)) +
  geom_col(position = "stack") +
  coord_flip() +
  scale_fill_manual(values = c("offensive_score" = "#B22222", "defensive_score" = "#3F51B5"),
                    labels = c("Offensive", "Defensive")) +
  labs(
    title = "Overall Type Rankings",
    subtitle = "Combined offensive and defensive effectiveness scores",
    x = "Type", y = "Score", fill = "Score Type"
  )
```

## 4. Pokemon Rating System

### 4.1 Rating Components

We develop a **dual-rating system** (100-point scale each) for competitive battling:

**Offensive Rating (100 points):**
1. **Efficient Stat Total (40 points)**: S-curve BST mapping with effective attack calculation
2. **Stat Distribution - Offensive (60 points)**:
   - Effective Attack Power (50%): Mixed offense recognition
   - Effective Speed Score (40%): Dual tactical value (fast/slow strategies)
   - Durability Buffer (10%): Minimum survivability

**Defensive Rating (100 points):**
1. **Efficient Stat Total (40 points)**: Same S-curve BST mapping
2. **Stat Distribution - Defensive (30 points)**:
   - Durability Expectation (80%): HP × √(Def × SpDef)
   - Counter-Attack Ability (20%): Minimum offensive threat
3. **Type Advantages (30 points)**: Defensive type matchup score

```{r rating-components}
# Smooth BST Score Calculator (40 points max)
# Uses logistic function (S-curve) for smooth transition
calc_bst_score <- function(total, atk, spatk, eff_atk) {
  # Parameters for S-curve - adjusted for higher scores
  # Midpoint at BST=450 (shifted left to give higher scores overall)
  # Steepness: gradual transition from 250-700
  L <- 40      # Maximum score
  k <- 0.015   # Steepness (increased for faster growth)
  x0 <- 450    # Inflection point (lowered to boost scores)
  bst = total - atk - spatk + eff_atk  # Use effective attack to avoid double counting

  # Logistic function: L / (1 + exp(-k * (x - x0)))
  score <- L / (1 + exp(-k * (bst - x0)))

  # Ensure minimum of 5 points for very weak Pokemon
  return(score)
}

# Efficient Attack Power Calculator
# Recognizes mixed offense vs specialized attackers
calc_eff_atk <- function(atk, spatk){
  ratio <- pmin(atk, spatk) / pmax(atk, spatk)
  # If ratio >= 0.9, it's a mixed attacker: use weighted sum
  # Otherwise, it's specialized: use the higher value
  ifelse(ratio < 0.9, pmax(atk, spatk), 0.6*(atk + spatk))
}

# Durability Expectations Calculator
# Uses geometric mean to penalize unbalanced defenses
calc_eff_def <- function(hp, def, spdef){
  hp * sqrt(def * spdef)
}

# Effective Speed Score Calculator
# Dual evaluation: base speed + tactical value
calc_eff_spd <- function(spd, vmin, vmax, v0 = 80){
  # B: "Faster is better" - linear normalization
  B <- (spd - vmin) / (vmax - vmin)
  # D: "Tactical value" - distance from baseline speed
  # Both very fast and very slow have tactical value
  D <- (abs(spd - v0)) / max(v0 - vmin, vmax - v0)
  # Combined: base speed (67%) + tactical value (33%)
  B + 0.5 * D
}

# Offensive Stat Distribution Score (60 points)
calc_atk_score <- function(eff_atk_s, eff_def_s, eff_spd_s){
  # Attack-oriented: prioritize offense (50%) and speed (40%)
  # Minimal durability requirement (10%)
  (0.5*eff_atk_s + 0.1*eff_def_s + 0.4*eff_spd_s) * 60
}

# Defensive Stat Distribution Score (30 points from stats + 30 points from type)
calc_def_score <- function(eff_atk_s, eff_def_s, defensive_score){
  # Defense-oriented: prioritize durability (80% of 30pts)
  # Keep some offensive threat (20% of 30pts)
  # Plus type advantage score (30pts from defensive matchups)
  (0.8*eff_def_s + 0.2*eff_atk_s) * 30 + 30 * defensive_score/100
}
```

### 4.3 Calculate Dual Ratings

```{r calculate-ratings}
#Give each Pokemon a Defense Type Score
TYPE_ORDER <- c(
  "Normal","Fire","Water","Electric","Grass","Ice",
  "Fighting","Poison","Ground","Flying","Psychic",
  "Bug","Rock","Ghost","Dragon","Dark","Steel","Fairy"
)

# Add defense type column to Pokemon data
pokemon_df_typed <- pokemon_df |>
  mutate(
    idx1 = match(type_1, TYPE_ORDER),
    idx2 = match(type_2, TYPE_ORDER),
    def_type = case_when(
      is.na(type_2) ~ type_1,
      TRUE ~ paste(
        TYPE_ORDER[pmin(idx1, idx2)],
        TYPE_ORDER[pmax(idx1, idx2)],
        sep = "/"
      )
    )
  ) |>
  left_join(
    def_stats_scaled |> select(def_type, defensive_score),
    by = "def_type"
  )

# Calculate rating for each Pokemon
pokemon_rated <- pokemon_df_typed |>
  mutate(
    # Step 1: Calculate raw effective values
    eff_atk = calc_eff_atk(attack, sp_atk),
    eff_def = calc_eff_def(hp, defense, sp_def),
    eff_spd = calc_eff_spd(speed, min(speed), max(speed)),

    # Step 2: Normalize to [0,1] scale
    eff_atk_s = eff_atk / max(eff_atk),
    eff_def_s = eff_def / max(eff_def),
    eff_spd_s = eff_spd / max(eff_spd),

    # Step 3: Calculate BST score (shared by both ratings)
    bst_score = calc_bst_score(total, attack, sp_atk, eff_atk),

    # Step 4: Calculate final ratings
    offensive_rating = bst_score + calc_atk_score(eff_atk_s, eff_def_s, eff_spd_s),
    defensive_rating = bst_score + calc_def_score(eff_atk_s, eff_def_s, defensive_score),

    # Tier Assignment based on composite score
    tier = case_when(
      offensive_rating >= 75 | defensive_rating >= 65 ~ "SS",  # Elite Pokemon
      offensive_rating >= 65 | defensive_rating >= 55 ~ "S",  # Strong Pokemon
      offensive_rating >= 55 | defensive_rating >= 45 ~ "A",  # Above average
      offensive_rating >= 45 | defensive_rating >= 35 ~ "B",  # Average
      offensive_rating >= 35 | defensive_rating >= 25 ~ "C",  # Below average
      TRUE ~ "F"                 # Weak Pokemon
    ),

    # Role classification based on rating difference
    role = case_when(
      offensive_rating / defensive_rating >= 1.15 ~ "Offensive",
      offensive_rating / defensive_rating <= 0.85 ~ "Defensive",
      TRUE ~ "Balanced"
    )
  )

# Set tier as factor
pokemon_rated$tier <- factor(pokemon_rated$tier, levels = c("SS", "S", "A", "B", "C", "F"))
pokemon_rated$role <- factor(pokemon_rated$role, levels = c("Offensive", "Balanced", "Defensive"))
```

### 4.4 Visualize Scoring Functions

```{r visualize-scoring-functions}
# Create data for visualization
bst_range <- seq(200, 800, by = 5)
atk_pairs <- expand.grid(atk = seq(50, 200, 10), spatk = seq(50, 200, 10))
spd_range <- seq(5, 200, by = 5)

# BST Score visualization
bst_viz <- tibble(
  BST = bst_range,
  # Use dummy values for attack stats
  Score = sapply(bst_range, function(x) calc_bst_score(x, 100, 100, 100))
)

p1 <- ggplot(bst_viz, aes(x = BST, y = Score)) +
  geom_line(color = "#2196F3", size = 1.5) +
  geom_hline(yintercept = c(10, 20, 30, 40), linetype = "dashed", alpha = 0.3) +
  geom_vline(xintercept = 450, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 450, y = 35, label = "Inflection Point\n(BST=450)",
           color = "red", size = 3) +
  labs(
    title = "BST Score: Smooth S-Curve Mapping",
    subtitle = "Logistic function for gradual strength scaling",
    x = "Base Stat Total (BST)", y = "BST Score (max 40)"
  ) +
  theme_minimal()

# Effective Attack visualization
eff_atk_viz <- atk_pairs |>
  mutate(
    eff_atk = calc_eff_atk(atk, spatk),
    ratio = pmin(atk, spatk) / pmax(atk, spatk),
    type = ifelse(ratio >= 0.9, "Mixed", "Specialized")
  )

p2 <- ggplot(eff_atk_viz, aes(x = atk, y = spatk, fill = eff_atk)) +
  geom_tile() +
  geom_contour(aes(z = eff_atk), color = "white", alpha = 0.3) +
  scale_fill_viridis_c(option = "plasma") +
  geom_abline(slope = 1, linetype = "dashed", color = "white") +
  annotate("text", x = 180, y = 180, label = "Mixed\nOffense",
           color = "white", size = 4, fontface = "bold") +
  annotate("text", x = 180, y = 80, label = "Specialized",
           color = "white", size = 4, fontface = "bold") +
  labs(
    title = "Effective Attack Power",
    subtitle = "Recognizes mixed offense (ratio ≥ 0.9) vs specialization",
    x = "Attack", y = "Special Attack", fill = "Eff. Attack"
  ) +
  theme_minimal()

# Effective Speed visualization
spd_viz <- tibble(
  Speed = spd_range,
  Score = calc_eff_spd(spd_range, min(spd_range), max(spd_range)),
  # Decompose into components
  B = (spd_range - min(spd_range)) / (max(spd_range) - min(spd_range)),
  D = abs(spd_range - 80) / max(80 - min(spd_range), max(spd_range) - 80) * 0.5
)

p3 <- ggplot(spd_viz, aes(x = Speed)) +
  geom_line(aes(y = Score, color = "Total Score"), size = 1.5) +
  geom_line(aes(y = B, color = "Base Speed (B)"), linetype = "dashed") +
  geom_line(aes(y = D, color = "Tactical Value (D)"), linetype = "dotted") +
  geom_vline(xintercept = 80, linetype = "dashed", color = "red", alpha = 0.5) +
  annotate("text", x = 80, y = 1.3, label = "Baseline\nSpeed=80",
           color = "red", size = 3) +
  scale_color_manual(values = c("Total Score" = "#4CAF50",
                                 "Base Speed (B)" = "#2196F3",
                                 "Tactical Value (D)" = "#FF9800")) +
  labs(
    title = "Effective Speed Score: Dual Tactical Value",
    subtitle = "Both very fast and very slow have strategic importance",
    x = "Speed Stat", y = "Normalized Score", color = "Component"
  ) +
  theme_minimal()

# Display all plots
if (requireNamespace("patchwork", quietly = TRUE)) {
  library(patchwork)
  (p1 | p2) / p3
} else {
  print(p1)
  print(p2)
  print(p3)
}
```

### 4.5 Rating Distribution Analysis

```{r rating-distribution}
# Summary by tier
tier_summary <- pokemon_rated |>
  count(tier) |>
  mutate(percentage = round(100 * n / sum(n), 1))

kable(tier_summary, caption = "Pokemon Distribution by Tier")

# Summary by role
role_summary <- pokemon_rated |>
  count(role) |>
  mutate(percentage = round(100 * n / sum(n), 1))

kable(role_summary, caption = "Pokemon Distribution by Battle Role")

# Visualize dual rating distribution
ggplot(pokemon_rated, aes(x = offensive_rating, y = defensive_rating)) +
  geom_point(aes(color = tier, shape = role), alpha = 0.6, size = 3) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("SS" = "#FF3CAC", "S" = "#FFD700", "A" = "#9C27B0",
                                 "B" = "#2196F3", "C" = "#4CAF50", "F" = "#9E9E9E")) +
  labs(
    title = "Offensive vs Defensive Rating Distribution",
    subtitle = "Points above diagonal = defense-oriented, below = offense-oriented",
    x = "Offensive Rating", y = "Defensive Rating",
    color = "Tier", shape = "Role"
  ) +
  theme_minimal()
```

### 4.6 Top Rated Pokemon

```{r top-rated}
# Top 20 offensive Pokemon
top_offensive <- pokemon_rated |>
  arrange(desc(offensive_rating)) |>
  head(20) |>
  select(name, type_1, type_2, role, offensive_rating, defensive_rating, eff_atk, tier)

cat("=== TOP 20 OFFENSIVE POKEMON ===\n")
kable(top_offensive, caption = "Top 20 Offensive Pokemon", digits = 1)

# Top 20 defensive Pokemon
top_defensive <- pokemon_rated |>
  arrange(desc(defensive_rating)) |>
  head(20) |>
  select(name, type_1, type_2, role, defensive_rating, offensive_rating, tier, defensive_score)

cat("\n=== TOP 20 DEFENSIVE POKEMON ===\n")
kable(top_defensive, caption = "Top 20 Defensive Pokemon", digits = 1)


# Top regular Pokemon (for beginners)
top_regular <- pokemon_rated |>
  filter(category == "Regular") |>
  arrange(desc(pmax(defensive_rating+10, offensive_rating))) |>
  head(20) |>
  select(name, type_1, type_2, role, offensive_rating, defensive_rating, tier)

cat("\n=== TOP 20 REGULAR POKEMON (For Beginners) ===\n")
kable(top_regular, caption = "Top 20 Regular Pokemon", digits = 1)
```

### 4.7 Best Pokemon by Type

```{r best-by-type}
# Best offensive Pokemon for each primary type
best_offensive_by_type <- pokemon_rated |>
  filter(category == "Regular") |>
  group_by(type_1) |>
  slice_max(offensive_rating, n = 1) |>
  ungroup() |>
  arrange(desc(offensive_rating)) |>
  select(type_1, name, offensive_rating, role, tier)

cat("=== BEST OFFENSIVE POKEMON BY TYPE (Regular Only) ===\n")
kable(best_offensive_by_type, caption = "Best Offensive Pokemon by Type", digits = 1)

# Best defensive Pokemon for each primary type
best_defensive_by_type <- pokemon_rated |>
  filter(category == "Regular") |>
  group_by(type_1) |>
  slice_max(defensive_rating, n = 1) |>
  ungroup() |>
  arrange(desc(defensive_rating)) |>
  select(type_1, name, defensive_rating, role, tier)

cat("\n=== BEST DEFENSIVE POKEMON BY TYPE (Regular Only) ===\n")
kable(best_defensive_by_type, caption = "Best Defensive Pokemon by Type", digits = 1)
```

### 4.8 Export Results

```{r export-results}
# Create output directory
dir.create(here("data", "analysis", "rating"), recursive = TRUE, showWarnings = FALSE)

# Save rated Pokemon data to CSV
write_csv(pokemon_rated, here("data", "analysis", "rating", "pokemon_rated.csv"))

# Create summary statistics
rating_summary <- pokemon_rated |>
  summarise(
    total_pokemon = n(),
    avg_offensive_rating = mean(offensive_rating),
    avg_defensive_rating = mean(defensive_rating),
    ss_tier_count = sum(tier == "SS"),
    s_tier_count = sum(tier == "S"),
    a_tier_count = sum(tier == "A"),
    b_tier_count = sum(tier == "B"),
    c_tier_count = sum(tier == "C"),
    f_tier_count = sum(tier == "F"),
    offensive_count = sum(role == "Offensive"),
    balanced_count = sum(role == "Balanced"),
    defensive_count = sum(role == "Defensive"),
    avg_bst_score = mean(bst_score),
    avg_eff_atk = mean(eff_atk),
    avg_eff_def = mean(eff_def),
    avg_eff_spd = mean(eff_spd)
  )

write_csv(rating_summary, here("data", "analysis", "rating", "rating_summary.csv"))

# Export top Pokemon lists for reference
write_csv(top_offensive, here("data", "analysis", "rating", "top_offensive_pokemon.csv"))
write_csv(top_defensive, here("data", "analysis", "rating", "top_defensive_pokemon.csv"))
write_csv(top_regular, here("data", "analysis", "rating", "top_regular_pokemon.csv"))

cat("\n=== DUAL RATING SYSTEM SUMMARY ===\n")
cat(sprintf("Total Pokemon: %d\n", rating_summary$total_pokemon))
cat(sprintf("\nAverage Ratings:\n"))
cat(sprintf("  Composite Rating: %.1f / 100\n", rating_summary$avg_total_rating))
cat(sprintf("  Offensive Rating: %.1f / 100\n", rating_summary$avg_offensive_rating))
cat(sprintf("  Defensive Rating: %.1f / 100\n", rating_summary$avg_defensive_rating))
cat(sprintf("\nRating Range: %.1f - %.1f\n", rating_summary$min_total_rating, rating_summary$max_total_rating))
cat(sprintf("\nTier Distribution:\n"))
cat(sprintf("  SS Tier: %d (%.1f%%)\n", rating_summary$s_tier_count, 100*rating_summary$s_tier_count/rating_summary$total_pokemon))
cat(sprintf("  S Tier: %d (%.1f%%)\n", rating_summary$a_tier_count, 100*rating_summary$a_tier_count/rating_summary$total_pokemon))
cat(sprintf("  A Tier: %d (%.1f%%)\n", rating_summary$b_tier_count, 100*rating_summary$b_tier_count/rating_summary$total_pokemon))
cat(sprintf("  B Tier: %d (%.1f%%)\n", rating_summary$c_tier_count, 100*rating_summary$c_tier_count/rating_summary$total_pokemon))
cat(sprintf("  C Tier: %d (%.1f%%)\n", rating_summary$d_tier_count, 100*rating_summary$d_tier_count/rating_summary$total_pokemon))
cat(sprintf("  F Tier: %d (%.1f%%)\n", rating_summary$f_tier_count, 100*rating_summary$f_tier_count/rating_summary$total_pokemon))
cat(sprintf("\nRole Distribution:\n"))
cat(sprintf("  Offensive: %d (%.1f%%)\n", rating_summary$offensive_count, 100*rating_summary$offensive_count/rating_summary$total_pokemon))
cat(sprintf("  Balanced: %d (%.1f%%)\n", rating_summary$balanced_count, 100*rating_summary$balanced_count/rating_summary$total_pokemon))
cat(sprintf("  Defensive: %d (%.1f%%)\n", rating_summary$defensive_count, 100*rating_summary$defensive_count/rating_summary$total_pokemon))
cat(sprintf("\nComponent Score Averages:\n"))
cat(sprintf("  BST Score: %.1f / 40\n", rating_summary$avg_bst_score))
cat(sprintf("  Effective Attack: %.1f\n", rating_summary$avg_eff_atk))
cat(sprintf("  Effective Defense: %.1f\n", rating_summary$avg_eff_def))
cat(sprintf("  Effective Speed: %.1f\n", rating_summary$avg_eff_spd))

cat("\n✓ Results exported to data/analysis/rating/:\n")
cat("  - pokemon_rated.csv (Complete ratings)\n")
cat("  - rating_summary.csv (Summary statistics)\n")
cat("  - top_offensive_pokemon.csv (Top 20 offensive)\n")
cat("  - top_defensive_pokemon.csv (Top 20 defensive)\n")
cat("  - top_regular_pokemon.csv (Top 20 for beginners)\n")
```
